<html>
  <head>
    <!-- JQuery UI theme -->
    <link href="jquery/themes/base/jquery-ui.css" rel="stylesheet">

    <!-- Stylesheets -->
    <link href="style.css" rel="stylesheet" type="text/css">

    <!-- sigma.js graph library -->
    <script type="text/javascript" src="sigma/sigma.concat.js"></script>

    <title>The Letter</title>
  </head>
  <body>

    <div class="letterWriterBody"> <!-- wraps everything so we can set background color -->

      <!-- Game container -->
      <div id="letterDebugger">
	<div id="editorMap"></div>
	<div id="gameAndParseTreeContainer">
	  <div id="gameContainer">
	    <span id="restart" class="letter restart"><small><i><a href="#" onclick="restartLetterFromGrammar()">Restart</a></i></small>
	      <span id="restartWarning"></span>
	    </span>
	    <span id="undo" class="letter undo"></span>
	    <h1>The Letter</h1>
	    
	    <span id="letter">
	      <!-- Preloading animation from http://preloaders.net/ -->
	      <br> Loading... <br> <br> <img src="img/loading.gif">
	    </span>

	    <br><br><br><br>
	    <div id="slidersParent" style="display:none"></div>

	    <br><br><br>
	  </div>
	  <div id="editorParseTree"></div>
	</div>
      </div>

      <div id="editor">
	<h5>Phrasebook</h5>
	<div id="editorList"></div>
	<small><i><a href="#" id="addNontermLink">Add a phrase</a></i></small>
	<h5>Sliders</h5>
	<div id="editorParams"></div>
	<small><i><a href="#" id="addSliderLink">Add a slider</a></i></small>
      </div>

      <div id="reveal">
	<small>
	  <i>Try modifying the template, then <a href="#" onclick="rebuildGrammarAndLetterFromText()">rebuild</a>.</i>
	  <br><i>You can also <a href="#" onclick="resetEverything()">reset</a> the template to the <a href="#" id="initialExample">initial example.</a></i>
	  <br><i>The template language describes a <a href="http://en.wikipedia.org/wiki/Context-free_grammar">context-free grammar</a>, which the player controls. The syntax can be found beneath the edit box.</i>
	</small>
	<br>
	<textarea id="editorTemplate" rows="10" columns="80" style="width: 100%; vertical-align: text-top">
	</textarea>
	<small><br>
	  <i><a href="#" id="SyntaxToggle">Template language syntax</a></i>
	<br>
	<div id="TemplateSyntax"></div></small>
      </div>

    </div>

    <!-- JQuery UI -->
    <script src="jquery/jquery-1.9.1.js"></script>
    <script src="jquery/ui/jquery-ui.js"></script>

 
    <!-- LetterWriter library & parser -->
    <script type="text/javascript" src="lib/letter.js"></script>
    <script type="text/javascript" src="lib/parser/letter.js"></script>

    <script type="text/javascript">
var grammar, letter, editor, template, storageKey, defaultSource;
storageKey = "LetterWriter"
defaultSource = "template/king.letter"
template = document.getElementById("editorTemplate")
var editorArgs = {tooltips:false}
//editorArgs = {}

$("#initialExample").attr("href",defaultSource)

function removeEditor() {
    if (editor) editor.remove()
    editor = null
}

function removeLetter() {
    $("#restartWarning").empty()
    if (letter) letter.clear()
    letter = null
}

function createEditor() {
    removeEditor()
    editor = grammar.newEditor(editorArgs)
    editor.warnChange ($("#restartWarning"), "The underlying template has been edited. Restart the letter to stay in sync.")
    editor.addNotify (function(){ localStorage.setItem(storageKey,template.value) })
}

function rebuildGrammarFromText() {
    grammar = new LetterWriter.Grammar(template.value).normalize()
    createEditor()
    restartLetterFromGrammar()
    editor.warnChangeFunction()
}

function restartLetterFromGrammar() {
    removeLetter()
    letter = grammar.clone().newLetter()
    letter.conceal = function() { }   // turn off conceal, don't hide edit box once we're done
}

function rebuildGrammarAndLetterFromText() {
    rebuildGrammarFromText()
    restartLetterFromGrammar()
}

function setupTemplateSyntax() {
    var xhr = new XMLHttpRequest();
    xhr.open ("GET", "doc/TemplateSyntax.html", false);
    xhr.send();
    $("#TemplateSyntax").append(xhr.responseText)

    function showSyntax(e) { e && e.preventDefault(); $("#TemplateSyntax").show(); $("#SyntaxToggle").click(hideSyntax) }
    function hideSyntax(e) { e && e.preventDefault(); $("#TemplateSyntax").hide(); $("#SyntaxToggle").click(showSyntax) }
    hideSyntax()
}

function loadInitialGrammar() {

    var storedText = localStorage.getItem(storageKey)

    grammar = (storedText && storedText.length > 0) ? new LetterWriter.Grammar(storedText) : LetterWriter.Grammar.newFromUrl(defaultSource)
    grammar = grammar.normalize()
    createEditor()

    $("#editorTemplate").change(null)
    template.value = grammar.toCanonicalString()
    $("#editorTemplate").change(rebuildGrammarFromText)

    letter = grammar.clone().newLetter()
}

function resetEverything() {
    if (confirm ("Really, delete everything?")) {
        localStorage.removeItem(storageKey)
        removeEditor()
        removeLetter()
        loadInitialGrammar()
    }
}

$(function(){
    setupTemplateSyntax()
    loadInitialGrammar()
});
    </script>

  </body>
</html>
