<html>
  <head>
    <!-- JQuery UI theme -->
    <link href="jquery/themes/base/jquery-ui.css" rel="stylesheet">

    <!-- Stylesheets -->
    <link href="css/style.css" rel="stylesheet" type="text/css">

    <!-- sigma.js graph library -->
    <script type="text/javascript" src="sigma/sigma.concat.js"></script>

    <title>The Letter</title>
  </head>
  <body style="background-color:#eee">

    <div class="letterWriterBody"> <!-- wraps everything so we can set background color -->

      <!-- Game container -->
      <div id="letterDebugger">
	<div id="gameAndParseTreeContainer">
	  <div id="leftPadding" style="width:400px;height:1em"></div>
	  <div id="gameContainer" style="border-style:none;left:400px">
	    <span id="restart" class="letter restart"><small><i><a href="#" onclick="restartLetterFromGrammar()">Restart</a></i></small>
	      <span id="restartWarning"></span>
	    </span>
	    <span id="undo" class="letter undo"></span>
	    <h1>The Letter</h1>
	    
	    <span id="letter">
	      <!-- Preloading animation from http://preloaders.net/ -->
	      <br> Loading... <br> <br> <img src="img/loading.gif">
	    </span>

	    <br><br><br><br>
	    <div id="slidersParent" style="display:none"></div>

	    <br><br><br>
	    <div id="scoreContainer" class="scoreContainerHidden"><span id="scoreLabel" class="scoreLabel"></span> <span id="score" class="score"></span></div>
	  </div>

	  <div id="editorParseTreeContainer" style="display:none">
	    <h5>Debugger</h5>
	    <div id="editorParseTree"></div>
	  </div>

	  <div style="float:right">
	    <form action="#">
	      IDE
	      <input type="checkbox" id="showIDECheckbox" name="ide" value="showIDE" onclick="changeShowIDE()">
	    </form>
	  </div>

	</div>

	<div id="editorMapContainer" style="display:none">
	  <a name="editorMap">
	    <h5>Choice Connection Map</h5>
	  </a>
	  <div id="editorMap"></div>
	</div>
      </div>

      <hr id="editorDivider" style="display:none">
      <div id="editor" style="display:none">

	<h5>ChoiceBook</h5>
	<div id="editorList"></div>
	<small><i><a href="#" id="addNontermLink">Add a choice</a></i></small>

	<hr>
	<h5>Sliders</h5>
	<div id="editorParams"></div>
	<small><i><a href="#" id="addSliderLink">Add a slider</a></i></small>

	<hr>
	<h5>Configuration</h5>

	<form><i>Initial recharge time for "undo":</i>
	  <input type="text" size="4" id="editorUndoWait"/>
	  <i>milliseconds (increases by <span id="editorUndoPercentIncrease"></span>% with each use)</i></form>

	<hr>
	<h5>Raw template</h5>
	<div id="reveal">
	  <small>
	    <i><a id="undoEdit">Undo</a>
              | <a id="redoEdit">Redo</a>
              | <a href="#" onclick="rebuildGrammarAndLetterFromText()">Run</a>
	      | <a href="#" id="templateSaveLink">Download</a>
              | <a href="#" onclick="resetEverything()">Reset</a> (to <a href="#" id="initialExample">initial example</a>)</i>
	  </small>
	  <br>
	  <textarea id="editorTemplate" rows="10" columns="80" style="width: 100%; vertical-align: text-top">
	  </textarea>
	  <div id="editorTemplateFailedLoad"></div>
	  <small><br>
	    <i><a href="#" id="SyntaxToggle">Template language syntax</a></i>
	    <br>
	    <div id="TemplateSyntax"></div></small>
	</div>
      </div>

    </div>

    <!-- JQuery UI -->
    <script src="jquery/jquery-1.9.1.js"></script>
    <script src="jquery/ui/jquery-ui.js"></script>

    <!-- DropIt dropdown menus -->
    <script src="jquery/dropit.js"></script>
    <link rel="stylesheet" href="css/dropit.css" type="text/css" />
 
    <!-- LetterWriter library & parser -->
    <script type="text/javascript" src="lib/letter.js"></script>
    <script type="text/javascript" src="lib/parser/letter.js"></script>

    <script type="text/javascript">
var grammar, letter, editor, template, storageKey, defaultSource;
storageKey = "LetterWriter"
defaultSource = "template/arcane.letter"
template = document.getElementById("editorTemplate")
var editorArgs = {tooltips:false}
//editorArgs = {}

$("#initialExample").attr("href",defaultSource)

function changeShowIDE() {
    if ($("#showIDECheckbox")[0].checked) {
	$("#editor,#editorMapContainer,#editorParseTreeContainer,#editorDivider").show()
	$(".letterWriterBody").attr("style","background-color:#fffff8")
	$("#gameContainer").attr("style","border-style:solid")
	$("#scoreContainer").attr("style","position:static;width:auto;bottom:auto")
    } else {
	$("#editor,#editorMapContainer,#editorParseTreeContainer,#editorDivider").hide()
	$(".letterWriterBody").attr("style","background-color:#eee")
	$("#gameContainer").attr("style","border-style:none;left:400px")
	$("#scoreContainer").attr("style","left:400px")
    }
}

function removeEditor() {
    if (editor) editor.remove()
    editor = null
}

function removeLetter() {
    $("#restartWarning").empty()
    if (letter) letter.clear()
    letter = null
}

function saveTemplateInStorage(){
    localStorage.setItem (storageKey, template.value)
    initSaveLink()
}

function initSaveLink(){
    $("#templateSaveLink").attr("href","data:text/plain;charset=utf-8," + encodeURIComponent(template.value)).attr("download","template.txt")
}

function createEditor() {
    removeEditor()
    editor = grammar.newEditor(editorArgs)
    editor.warnChange ($("#restartWarning"), "The underlying template has been edited. Restart the letter to stay in sync.")
// the following line is disabled, meaning that click-navigation from parse tree to editor
// will still be attempted, even if parse tree has gotten out of sync with editor
// This may cause errors which are not currently caught...
//    editor.addNotify (function() { letter.detachEditor() })
    editor.addNotify (saveTemplateInStorage)
    editor.addNotify (recordEdit)
}

function rebuildGrammarFromText() {
    try {
        grammar = new LetterWriter.Grammar(template.value).normalize()
        createEditor()
        restartLetterFromGrammar()
// do a bit of notifying (calling the editor's main notify function would update this textarea, not what we want)
        editor.warnChangeFunction()
        saveTemplateInStorage()
	$("#editorTemplate").focus()
    } catch (e) { }
}

function templateEdited() {
    rebuildGrammarFromText()
    recordEdit()

    redoHistory = []
    $("#redoEdit").removeAttr("href")  // disable redo link
}

function restartLetterFromGrammar() {
    removeLetter()
    letter = grammar.clone().newLetter()
    letter.attachEditor(editor)
}

function rebuildGrammarAndLetterFromText() {
    rebuildGrammarFromText()
    restartLetterFromGrammar()
}

function setupTemplateSyntax() {
    var xhr = new XMLHttpRequest();
    xhr.open ("GET", "doc/TemplateSyntax.html", false);
    xhr.send();
    $("#TemplateSyntax").append(xhr.responseText)

    function showSyntax(e) { e && e.preventDefault(); $("#TemplateSyntax").show(); $("#SyntaxToggle").click(hideSyntax) }
    function hideSyntax(e) { e && e.preventDefault(); $("#TemplateSyntax").hide(); $("#SyntaxToggle").click(showSyntax) }
    hideSyntax()
}

function loadInitialGrammar() {

    var storedText = localStorage.getItem(storageKey)

    try {
	grammar = (storedText && storedText.length > 0 && /\S/.test(storedText))
	    ? new LetterWriter.Grammar(storedText)
	    : LetterWriter.Grammar.newFromUrl(defaultSource)
    } catch (e) {
	$("#editorTemplateFailedLoad").append("<i>Failed to initialize:</i><br><code><verbatim>" + storedText + "</verbatim></code><br><span class=\"undefinedParameter\">" + e.message + "</span></font>")
	console.log(e.message);
	grammar = LetterWriter.Grammar.newFromUrl(defaultSource)
    }
    grammar = grammar.normalize()
    createEditor()

    $("#editorTemplate").change(null)
    template.value = grammar.toCanonicalString()
    $("#editorTemplate").change(templateEdited)
    initSaveLink()
    initEditHistory()

    restartLetterFromGrammar()
}

function resetEverything() {
    if (confirm ("Really, delete everything?")) {
        localStorage.removeItem(storageKey)
        removeEditor()
        removeLetter()
        loadInitialGrammar()
    }
}


var undoHistory, redoHistory;
var maxUndos = 10;

function recordEdit() {
    var str = editor.grammar.toCanonicalString()
    if (undoHistory.length == 0 || str != undoHistory[undoHistory.length - 1]) {
	undoHistory.push (str)
	if (undoHistory.length >= maxUndos)
	    undoHistory.shift()
	if (undoHistory.length > 1)
	    $("#undoEdit").attr("href","#")  // enable undo link
    }
}

function initEditHistory() {
    undoHistory = [template.value]
    redoHistory = []
    $("#undoEdit").removeAttr("href")  // disable undo link
    $("#redoEdit").removeAttr("href")  // disable redo link
}

function undoEdit(e) {
    e.preventDefault()
    var str = grammar.toCanonicalString()
    var oldStr = str;
    while (undoHistory.length > 0 && str == oldStr) {
	var oldStr = undoHistory.pop()
    }
    if (undoHistory.length == 0)
	$("#undoEdit").removeAttr("href")  // disable undo link
    if (oldStr != str) {
	redoHistory.push(str)
	template.value = oldStr
	rebuildGrammarFromText()
	recordEdit()
	$("#redoEdit").attr("href","#")  // enable redo link
    }
}
$("#undoEdit").click(undoEdit)

function redoEdit(e) {
    e.preventDefault()
    if (redoHistory.length > 0) {
	template.value = redoHistory.pop()
	rebuildGrammarFromText()
	if (redoHistory.length == 0)
	    $("#redoEdit").removeAttr("href")  // disable redo link
	recordEdit()
    }
}
$("#redoEdit").click(redoEdit)


$(function(){
    setupTemplateSyntax()
    loadInitialGrammar()
    changeShowIDE()
});
    </script>

  </body>
</html>
